import { useState, useEffect, useCallback } from 'react';
import './PendingTasksPanel.css';

// Priority color mapping per spec
const PRIORITY_COLORS = {
  CRITICAL: '#ff4444',
    HIGH: '#ffaa00',
      MEDIUM: '#00ff88',
        LOW: '#666666'
        };

        // Priority order for sorting
        const PRIORITY_ORDER = { CRITICAL: 0, HIGH: 1, MEDIUM: 2, LOW: 3 };

        // All roles for filtering
        const ALL_ROLES = [
          'database-architect', 'backend-developer', 'frontend-developer',
            'devops', 'chief-of-staff', 'ceo', 'cfo', 'cto', 'cmo', 'chro',
              'ciso', 'general-counsel', 'chief-compliance-officer',
                'chief-data-officer', 'chief-strategy-officer',
                  'chief-procurement-officer', 'chief-sustainability-officer'
                  ];

                  const PendingTasksPanel = ({ isOpen, onClose }) => {
                    const [tasks, setTasks] = useState([]);
                      const [loading, setLoading] = useState(true);
                        const [error, setError] = useState(null);
                          const [selectedRole, setSelectedRole] = useState(null);
                            const [sortBy, setSortBy] = useState('priority'); // 'priority' or 'age'
                              const [byPriority, setByPriority] = useState({});

                                // Fetch pending tasks
                                  const fetchTasks = useCallback(async () => {
                                      try {
                                            const response = await fetch('/api/pending-tasks');
                                                  if (!response.ok) throw new Error('Failed to fetch pending tasks');
                                                        const data = await response.json();
                                                              setTasks(data.tasks || []);
                                                                    setByPriority(data.by_priority || {});
                                                                          setError(null);
                                                                              } catch (err) {
                                                                                    setError(err.message);
                                                                                          console.error('Error fetching pending tasks:', err);
                                                                                              } finally {
                                                                                                    setLoading(false);
                                                                                                        }
                                                                                                          }, []);

                                                                                                            // Initial fetch and auto-refresh every 30 seconds
                                                                                                              useEffect(() => {
                                                                                                                  fetchTasks();
                                                                                                                      const interval = setInterval(fetchTasks, 30000);
                                                                                                                          return () => clearInterval(interval);
                                                                                                                            }, [fetchTasks]);

                                                                                                                              // Calculate hours pending from created_at
                                                                                                                                const getHoursPending = (createdAt) => {
                                                                                                                                    const created = new Date(createdAt);
                                                                                                                                        const now = new Date();
                                                                                                                                            const hours = Math.round((now - created) / (1000 * 60 * 60) * 10) / 10;
                                                                                                                                                return hours;
                                                                                                                                                  };

                                                                                                                                                    // Format role for display
                                                                                                                                                      const formatRole = (role) => {
                                                                                                                                                          return role.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                                                                                                                                                            };

                                                                                                                                                              // Filter and sort tasks
                                                                                                                                                                const getFilteredAndSortedTasks = () => {
                                                                                                                                                                    let filtered = tasks;
                                                                                                                                                                        
                                                                                                                                                                            if (selectedRole) {
                                                                                                                                                                                  filtered = tasks.filter(task => task.assigned_role === selectedRole);
                                                                                                                                                                                      }
                                                                                                                                                                                          
                                                                                                                                                                                              return [...filtered].sort((a, b) => {
                                                                                                                                                                                                    if (sortBy === 'priority') {
                                                                                                                                                                                                            return PRIORITY_ORDER[a.priority] - PRIORITY_ORDER[b.priority];
                                                                                                                                                                                                                  } else {
                                                                                                                                                                                                                          // Sort by age (oldest first)
                                                                                                                                                                                                                                  return new Date(a.created_at) - new Date(b.created_at);
                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                            });
                                                                                                                                                                                                                                              };

                                                                                                                                                                                                                                                // Get unique roles from tasks
                                                                                                                                                                                                                                                  const getActiveRoles = () => {
                                                                                                                                                                                                                                                      const roles = [...new Set(tasks.map(t => t.assigned_role))];
                                                                                                                                                                                                                                                          return roles.sort();
                                                                                                                                                                                                                                                            };

                                                                                                                                                                                                                                                              const filteredTasks = getFilteredAndSortedTasks();

                                                                                                                                                                                                                                                                if (!isOpen) return null;

                                                                                                                                                                                                                                                                  return (
                                                                                                                                                                                                                                                                      <div className="pending-tasks-overlay" onClick={onClose}>
                                                                                                                                                                                                                                                                            <div className="pending-tasks-panel" onClick={e => e.stopPropagation()}>
                                                                                                                                                                                                                                                                                    {/* Header */}
                                                                                                                                                                                                                                                                                            <div className="pending-tasks-header">
                                                                                                                                                                                                                                                                                                      <div className="header-left">
                                                                                                                                                                                                                                                                                                                  <h2>PENDING TASKS ({tasks.length})</h2>
                                                                                                                                                                                                                                                                                                                              <div className="priority-summary">
                                                                                                                                                                                                                                                                                                                                            {Object.entries(byPriority).map(([priority, count]) => (
                                                                                                                                                                                                                                                                                                                                                            <span 
                                                                                                                                                                                                                                                                                                                                                                              key={priority}
                                                                                                                                                                                                                                                                                                                                                                                                className="priority-count"
                                                                                                                                                                                                                                                                                                                                                                                                                  style={{ color: PRIORITY_COLORS[priority] }}
                                                                                                                                                                                                                                                                                                                                                                                                                                  >
                                                                                                                                                                                                                                                                                                                                                                                                                                                    {priority}: {count}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ))}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div className="header-right">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <select 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            value={sortBy} 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          onChange={e => setSortBy(e.target.value)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        className="sort-select"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <option value="priority">Sort: Priority</option>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <option value="age">Sort: Age</option>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </select>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <button className="close-btn" onClick={onClose}>×</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  {/* Role Filter */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div className="role-filter">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                className={`filter-btn ${!selectedRole ? 'active' : ''}`}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            onClick={() => setSelectedRole(null)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  All
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      {getActiveRoles().map(role => (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                key={role}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              className={`filter-btn ${selectedRole === role ? 'active' : ''}`}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            onClick={() => setSelectedRole(role)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      {formatRole(role)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ))}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {/* Content */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div className="pending-tasks-content">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              {loading ? (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div className="loading-state">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div className="loading-spinner"></div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <span>Loading tasks...</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ) : error ? (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div className="error-state">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <span className="error-icon">⚠</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <span>{error}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <button onClick={fetchTasks}>Retry</button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ) : filteredTasks.length === 0 ? (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div className="empty-state">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <span>No pending tasks{selectedRole ? ` for ${formatRole(selectedRole)}` : ''}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ) : (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div className="tasks-list">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  {filteredTasks.map(task => (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div key={task.id} className="task-card">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div className="task-priority">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <span 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              className="priority-badge"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    style={{ 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            backgroundColor: PRIORITY_COLORS[task.priority],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    color: task.priority === 'LOW' ? '#fff' : '#000'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {task.priority}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div className="task-content">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <div className="task-title">{task.content}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div className="task-meta">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <span className="task-role">{formatRole(task.assigned_role)}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <span className="task-separator">|</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <span className="task-workflow">{task.workflows?.name || 'N/A'}</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <span className="task-separator">|</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <span className="task-age">{getHoursPending(task.created_at)}h ago</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      ))}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {/* Footer */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div className="pending-tasks-footer">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <span className="refresh-info">Auto-refresh: 30s</span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <button className="refresh-btn" onClick={fetchTasks}>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    ↻ Refresh Now
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  export default PendingTasksPanel;