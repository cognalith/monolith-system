import { useState, useEffect } from 'react';
import PendingTasksPanel from './PendingTasksPanel';
import ErrorBoundary from './ErrorBoundary';

const CEODashboard = () => {
  const [stats, setStats] = useState(null);
    const [activity, setActivity] = useState([]);
      const [loading, setLoading] = useState(true);
        const [error, setError] = useState(null);
          const [selectedRole, setSelectedRole] = useState('chief-of-staff');
            const [showTasksPanel, setShowTasksPanel] = useState(false);

            const roles = [
                'chief-of-staff', 'ceo', 'cfo', 'cto', 'cmo', 'chro', 'ciso',
                    'general-counsel', 'chief-compliance-officer', 'chief-data-officer',
                        'chief-strategy-officer', 'chief-procurement-officer', 'chief-sustainability-officer'
                          ];

                            // Task 5.2.1: API Integration with auto-refresh
                              useEffect(() => {
                                  const Page_DownData = async () => {
                                        try {
                                                setLoading(true);
                                                        setError(null);

                                                                // Try to fetch from backend API (port 3000)
                                                                        const statsRes = await fetch('http://localhost:3000/api/dashboard/stats', {
                                                                                  headers: { 'Content-Type': 'application/json' }
                                                                                          });
                                                                                                  const activityRes = await fetch('http://localhost:3000/api/recent-activity', {
                                                                                                            headers: { 'Content-Type': 'application/json' }
                                                                                                                    });

                                                                                                                            if (!statsRes.ok || !activityRes.ok) throw new Error('API unavailable');

                                                                                                                                    const statsData = await statsRes.json();
                                                                                                                                            const activityData = await activityRes.json();

                                                                                                                                                    setStats(statsData);
                                                                                                                                                            setActivity(activityData);
                                                                                                                                                                  } catch (err) {
                                                                                                                                                                          setError(err.message);
                                                                                                                                                                                  console.warn('API failed, using mock data:', err.message);

                                                                                                                                                                                          // Fallback to mock data with visual delay for UX
                                                                                                                                                                                                  setTimeout(() => {
                                                                                                                                                                                                            setStats({
                                                                                                                                                                                                                        activeWorkflows: 3,
                                                                                                                                                                                                                                    pendingTasks: 12,
                                                                                                                                                                                                                                                completedToday: 8,
                                                                                                                                                                                                                                                            totalDecisions: 156
                                                                                                                                                                                                                                                                      });
                                                                                                                                                                                                                                                                                setActivity([
                                                                                                                                                                                                                                                                                            { id: 1, action: 'Approved Q4 budget', timestamp: new Date(Date.now() - 5 * 60000), role: 'cfo' },
                                                                                                                                                                                                                                                                                                        { id: 2, action: 'Reviewed compliance report', timestamp: new Date(Date.now() - 15 * 60000), role: 'chief-compliance-officer' },
                                                                                                                                                                                                                                                                                                                    { id: 3, action: 'Assigned procurement task', timestamp: new Date(Date.now() - 30 * 60000), role: 'chief-procurement-officer' }
                                                                                                                                                                                                                                                                                                                              ]);
                                                                                                                                                                                                                                                                                                                                        setError(null);
                                                                                                                                                                                                                                                                                                                                                }, 500);
                                                                                                                                                                                                                                                                                                                                                      } finally {
                                                                                                                                                                                                                                                                                                                                                              setLoading(false);
                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                        };

                                                                                                                                                                                                                                                                                                                                                                            Page_DownData();

                                                                                                                                                                                                                                                                                                                                                                                // Auto-refresh every 30 seconds
                                                                                                                                                                                                                                                                                                                                                                                    const interval = setInterval(Page_DownData, 30000);
                                                                                                                                                                                                                                                                                                                                                                                        return () => clearInterval(interval);
                                                                                                                                                                                                                                                                                                                                                                                          }, []);

                                                                                                                                                                                                                                                                                                                                                                                            // Task 5.2.2: Visual Polish - Animations and enhanced styling
                                                                                                                                                                                                                                                                                                                                                                                              const pulseAnimation = 'animate-pulse';
                                                                                                                                                                                                                                                                                                                                                                                                const fadeInAnimation = 'animate-fadeIn';

                                                                                                                                                                                                                                                                                                                                                                                                  return (
                                                                                                                                                                                                                                                                                                                                                                                                      <div className="min-h-screen bg-monolith-dark text-gray-100 p-6">
                                                                                                                                                                                                                                                                                                                                                                                                            {/* Header with animated title */}
                                                                                                                                                                                                                                                                                                                                                                                                                  <div className={`mb-8 ${fadeInAnimation}`}>
                                                                                                                                                                                                                                                                                                                                                                                                                          <h1 className="text-4xl font-bold text-monolith-green mb-2">CEO Dashboard</h1>
                                                                                                                                                                                                                                                                                                                                                                                                                                  <p className="text-gray-400">Unified Command & Control Center</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                          {loading && <p className="text-sm text-monolith-amber mt-2">Loading...</p>}
                                                                                                                                                                                                                                                                                                                                                                                                                                                  {error && <p className="text-sm text-red-500 mt-2">Using cached data</p>}
                                                                                                                                                                                                                                                                                                                                                                                                                                                        </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                              {/* Role Selector */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div className="mb-6 flex flex-wrap gap-2">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {roles.map(role => (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <button
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  key={role}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              onClick={() => setSelectedRole(role)}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          className={`px-4 py-2 rounded text-sm font-medium transition-all ${
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        selectedRole === role
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ? 'bg-monolith-green text-monolith-dark'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        : 'bg-gray-800 text-gray-300 hover:bg-gray-700'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }`}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          {role.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </button>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            ))}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        {/* Stats Grid with visual enhancements */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              {stats && (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <StatCard label="Active Workflows" value={stats.activeWorkflows} color="green" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div onClick={() => setShowTasksPanel(true)} style={{cursor: "pointer"}}><StatCard label="Pending Tasks" value={stats.pendingTasks} color="amber" /></div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <StatCard label="Completed Today" value={stats.completedToday} color="green" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <StatCard label="Total Decisions" value={stats.totalDecisions} color="gray" />
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            )}

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  {/* Activity Feed with animations */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div className="mb-8">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <h2 className="text-2xl font-bold mb-4 text-monolith-amber">Recent Activity</h2>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div className="space-y-3 max-h-96 overflow-y-auto">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  {activity.length > 0 ? (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              activity.map((item, idx) => (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            key={item.id}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            className={`${fadeInAnimation} p-4 bg-gray-800 border border-gray-700 rounded-lg hover:border-monolith-green transition-colors cursor-pointer group`}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            style={{ animationDelay: `${idx * 100}ms` }}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          >
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <div className="flex justify-between items-start">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                <p className="text-gray-100 group-hover:text-monolith-green transition-colors">{item.action}</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <p className="text-xs text-gray-500 mt-1">Role: {item.role}</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <span className="text-xs text-gray-400">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {item.timestamp.toLocaleTimeString()}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </span>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        ))
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  ) : (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <p className="text-gray-400 text-center py-8">No recent activity</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        )}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {/* Role Context Panel */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div className="bg-gray-900 border border-gray-700 rounded-lg p-6">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <h3 className="text-xl font-bold text-monolith-green mb-4">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    {selectedRole.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ')} Context
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </h3>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    <div className="text-gray-300 text-sm space-y-2">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              <p>Role: <span className="text-monolith-amber">{selectedRole}</span></p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <p>Status: <span className="text-monolith-green animate-pulse">Active</span></p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <p className="mt-4 text-gray-400">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              This role has access to critical business functions and decision-making authority.
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        </p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      </div>

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            {/* Footer */}
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div className="mt-8 text-center text-gray-500 text-xs">
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          <p>Last updated: {new Date().toLocaleTimeString()} | Auto-refresh every 30 seconds</p>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      const StatCard = ({ label, value, color }) => {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        const colorClasses = {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            green: 'text-monolith-green border-monolith-green/30',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                amber: 'text-monolith-amber border-monolith-amber/30',
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    gray: 'text-gray-400 border-gray-600/30'
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return (
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            <div className={`bg-gray-900 border ${colorClasses[color]} rounded-lg p-4 animate-fadeIn hover:border-current transition-colors`}>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  <div className="text-gray-500 text-sm uppercase tracking-wider mt-1">{label}</div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        <div className={`text-3xl font-bold ${colorClasses[color].split(' ')[0]} mt-4`}>{value}</div>
      <ErrorBoundary title="Tasks Panel Error"><PendingTasksPanel isOpen={showTasksPanel} onClose={() => setShowTasksPanel(false)} /></ErrorBoundary>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            </div>
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              );
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              };

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              export default CEODashboard;